import os
import zipfile
import csv

# Define the root folder
root_folder = os.path.dirname(os.path.abspath(__file__))

# Create the 'temp' folder if it doesn't exist
temp_folder = os.path.join(root_folder, 'temp')
os.makedirs(temp_folder, exist_ok=True)

# Search for .zip files in the root folder
zip_files = [f for f in os.listdir(root_folder) if f.endswith('.zip')]

# Extract the .csv files from each .zip file
for zip_file in zip_files:
    zip_path = os.path.join(root_folder, zip_file)
    with zipfile.ZipFile(zip_path, 'r') as zip_ref:
        zip_ref.extractall(temp_folder)

# Rename the .csv files
csv_files = [f for f in os.listdir(temp_folder) if f.endswith('.csv')]
for i, csv_file in enumerate(csv_files):
    file_name, file_ext = os.path.splitext(csv_file)
    if not file_name.startswith('1-'):
        new_file_name = f'{i + 1}-{file_name}{file_ext}'
        os.rename(os.path.join(temp_folder, csv_file), os.path.join(temp_folder, new_file_name))

# Remove the first line from each .csv file (except for the file starting with '1-')
for csv_file in csv_files:
    file_path = os.path.join(temp_folder, csv_file)
    with open(file_path, 'r') as file:
        lines = file.readlines()
    if not csv_file.startswith('1-'):
        with open(file_path, 'w') as file:
            file.writelines(lines[1:])

# Join all .csv files into a new file called 'report_final.csv'
report_file = os.path.join(temp_folder, 'report_final.csv')
with open(report_file, 'w') as report:
    csv_writer = None
    for csv_file in csv_files:
        file_path = os.path.join(temp_folder, csv_file)
        with open(file_path, 'r') as file:
            csv_reader = csv.reader(file)
            if csv_writer is None:
                csv_writer = csv.writer(report)
                csv_writer.writerows(csv_reader)
            else:
                next(csv_reader)  # Skip the header line
                csv_writer.writerows(csv_reader)

print("Process completed successfully!")

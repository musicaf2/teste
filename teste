import os
import zipfile
import csv

# Define the root folder where the .py executable is located
root_folder = os.path.dirname(os.path.abspath(__file__))

# Define the name of the temporary folder
temp_folder = os.path.join(root_folder, 'temp')

# Define the name of the final report file
final_report_file = os.path.join(root_folder, 'report_final.csv')

# Remove the 'temp' folder if it exists
if os.path.exists(temp_folder):
    os.rmdir(temp_folder)

# Remove the 'report_final.csv' file if it exists
if os.path.exists(final_report_file):
    os.remove(final_report_file)

# Search for .zip files in the root folder
zip_files = [file for file in os.listdir(root_folder) if file.endswith('.zip')]

# Extract the .zip files into the 'temp' folder
os.makedirs(temp_folder)
for zip_file in zip_files:
    zip_path = os.path.join(root_folder, zip_file)
    with zipfile.ZipFile(zip_path, 'r') as zip_ref:
        zip_ref.extractall(temp_folder)

# Search for .csv files in the 'temp' folder
csv_files = [file for file in os.listdir(temp_folder) if file.endswith('.csv')]

# Sort the .csv files in order
csv_files.sort()

# Rename and process the .csv files
for i, csv_file in enumerate(csv_files):
    csv_path = os.path.join(temp_folder, csv_file)
    new_csv_name = str(i + 1) + '.csv'
    new_csv_path = os.path.join(temp_folder, new_csv_name)

    # Rename the .csv file
    os.rename(csv_path, new_csv_path)

    # Remove the first line of the .csv file except for the first file
    if i > 0:
        with open(new_csv_path, 'r') as file:
            lines = file.readlines()[1:]
        with open(new_csv_path, 'w') as file:
            file.writelines(lines)

# Join all the .csv files into the final report file
with open(final_report_file, 'w') as final_report:
    for i, csv_file in enumerate(csv_files):
        csv_path = os.path.join(temp_folder, csv_file)
        with open(csv_path, 'r') as csv_file:
            if i != 0:  # Skip the header for files after the first one
                next(csv_file)
            final_report.write(csv_file.read())

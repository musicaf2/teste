import os
import zipfile
import csv
import shutil


def extract_zip_files(source_dir, destination_dir):
    """
    Extracts all zip files in the source directory and its subdirectories
    to the destination directory.
    """
    for root, dirs, files in os.walk(source_dir):
        for file in files:
            if file.endswith(".zip"):
                zip_file_path = os.path.join(root, file)
                common_prefix = os.path.commonprefix([source_dir, zip_file_path])
                relative_path = os.path.relpath(zip_file_path, common_prefix)
                folder_name = os.path.splitext(relative_path)[0]
                extract_folder_path = os.path.join(destination_dir, folder_name)
                os.makedirs(extract_folder_path, exist_ok=True)
                
                with zipfile.ZipFile(zip_file_path, 'r') as zip_ref:
                    zip_ref.extractall(extract_folder_path)


# The remaining functions (rename_csv_files, merge_csv_files, main) remain the same as before

# ...

# main function and other functions omitted for brevity

# ...

if __name__ == "__main__":
    # Finding the directory where the script is located
    script_dir = os.path.dirname(os.path.abspath(__file__))

    # Creating the temporary directory
    temp_dir = os.path.join(script_dir, "temp")
    os.makedirs(temp_dir, exist_ok=True)

    # Extracting zip files
    extract_zip_files(script_dir, temp_dir)

    # Renaming CSV files
    rename_csv_files(temp_dir)

    # Merging CSV files into a final report
    report_final_file_path = os.path.join(temp_dir, "report_final.csv")
    merge_csv_files(temp_dir, report_final_file_path)

    # Moving the final report file to the root directory
    final_report_for_script_path = os.path.join(script_dir, "report_final.csv")

    if os.path.exists(final_report_for_script_path):
        os.remove(final_report_for_script_path)

    shutil.move(report_final_file_path, script_dir)

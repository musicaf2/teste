import os
import zipfile
import csv

def extract_zip_files(root_folder):
    zip_files = []
    for dirpath, _, filenames in os.walk(root_folder):
        for filename in filenames:
            if filename.endswith(".zip"):
                zip_file_path = os.path.join(dirpath, filename)
                zip_files.append(zip_file_path)
    return zip_files

def extract_csv_from_zip(zip_file_path, target_folder):
    with zipfile.ZipFile(zip_file_path, 'r') as zip_ref:
        zip_ref.extractall(target_folder)

def rename_csv_files(target_folder):
    csv_files = []
    for dirpath, _, filenames in os.walk(target_folder):
        for filename in filenames:
            if filename.endswith(".csv"):
                csv_file_path = os.path.join(dirpath, filename)
                csv_files.append(csv_file_path)

    csv_files.sort()  # Sort the list of CSV files

    for i, csv_file_path in enumerate(csv_files, start=1):
        new_filename = f"{i}.csv"
        new_filepath = os.path.join(target_folder, new_filename)
        os.rename(csv_file_path, new_filepath)

def remove_first_line_from_csv(csv_file_path):
    with open(csv_file_path, 'r') as file:
        lines = file.readlines()

    with open(csv_file_path, 'w', newline='') as file:
        file.writelines(lines[1:])

def join_csv_files(csv_files, output_file):
    with open(output_file, 'w', newline='') as outfile:
        writer = csv.writer(outfile)
        header_written = False
        for csv_file in csv_files:
            with open(csv_file, 'r') as infile:
                reader = csv.reader(infile)
                if not header_written:
                    writer.writerows(reader)
                    header_written = True
                else:
                    next(reader)  # Skip the header line
                    writer.writerows(reader)

root_folder = "."  # Set the root folder here, or provide an absolute path

# Step 1: Extract .zip files into 'temp' folder
zip_files = extract_zip_files(root_folder)
target_folder = "temp"
os.makedirs(target_folder, exist_ok=True)
for zip_file in zip_files:
    extract_csv_from_zip(zip_file, target_folder)

# Step 2: Rename .csv files and remove first line
rename_csv_files(target_folder)
csv_files = [os.path.join(target_folder, filename) for filename in os.listdir(target_folder) if filename.endswith(".csv")]
for csv_file in csv_files[1:]:
    remove_first_line_from_csv(csv_file)

# Step 3: Join all .csv files into 'report_final.csv'
output_file = "report_final.csv"
join_csv_files(csv_files, output_file)

print("Process completed successfully!")

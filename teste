import os
import zipfile
import csv
import shutil


def extract_zip_files(source_dir, destination_dir):
    """
    Extracts all zip files in the source directory to the destination directory.
    """
    for root, dirs, files in os.walk(source_dir):
        for file in files:
            if file.endswith(".zip"):
                zip_file_path = os.path.join(root, file)
                folder_name = os.path.splitext(file)[0]
                extract_folder_path = os.path.join(destination_dir, folder_name)
                os.makedirs(extract_folder_path, exist_ok=True)
                
                with zipfile.ZipFile(zip_file_path, 'r') as zip_ref:
                    zip_ref.extractall(extract_folder_path)


def rename_csv_files(temp_dir):
    """
    Renames CSV files in the temporary directory, adding a numeric suffix
    to avoid files with the same name.
    """
    for root, dirs, files in os.walk(temp_dir):
        for file in files:
            if file.endswith(".csv"):
                old_csv_file_path = os.path.join(root, file)
                new_csv_file_name = f"{os.path.splitext(file)[0]}_1.csv"
                new_csv_file_path = os.path.join(temp_dir, new_csv_file_name)
                
                i = 2
                while os.path.exists(new_csv_file_path):
                    new_csv_file_name = f"{os.path.splitext(file)[0]}_{i}.csv"
                    new_csv_file_path = os.path.join(temp_dir, new_csv_file_name)
                    i += 1
                    
                shutil.move(old_csv_file_path, new_csv_file_path)


def merge_csv_files(temp_dir, output_path):
    """
    Merges all CSV files in the temporary directory into a single output file.
    The first line of each file, except the first one, is removed during the merge.
    """
    is_first_file = True
    
    with open(output_path, "w", newline="") as output:
        writer = csv.writer(output)
        
        for filename in os.listdir(temp_dir):
            if filename.endswith(".csv"):
                with open(os.path.join(temp_dir, filename), "r") as csvfile:
                    lines = list(csv.reader(csvfile))
                    
                    if not is_first_file and lines:
                        lines.pop(0)
                    
                    if lines:
                        writer.writerows(lines)
                
                if is_first_file:
                    is_first_file = False


def main():
    # Finding the directory where the script is located
    script_dir = os.path.dirname(os.path.abspath(__file__))

    # Creating the temporary directory
    temp_dir = os.path.join(script_dir, "temp")
    os.makedirs(temp_dir, exist_ok=True)

    # Extracting zip files
    extract_zip_files(script_dir, temp_dir)

    # Renaming CSV files
    rename_csv_files(temp_dir)

    # Merging CSV files into a final report
    report_final_file_path = os.path.join(temp_dir, "report_final.csv")
    merge_csv_files(temp_dir, report_final_file_path)

    # Moving the final report file to the root directory
    final_report_for_script_path = os.path.join(script_dir, "report_final.csv")

    if os.path.exists(final_report_for_script_path):
        os.remove(final_report_for_script_path)

    shutil.move(report_final_file_path, script_dir)


if __name__ == "__main__":
    main()

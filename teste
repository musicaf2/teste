import os
import zipfile
import csv
import shutil

root_folder = "."  # Set the root folder where the .py executable resides
temp_folder = "temp"
report_file = "report_final.csv"

# Step 1: Search for .zip files and extract them into the 'temp' folder
zip_files = [file for file in os.listdir(root_folder) if file.endswith(".zip")]

if not os.path.exists(temp_folder):
    os.makedirs(temp_folder)

for zip_file in zip_files:
    with zipfile.ZipFile(zip_file, 'r') as zip_ref:
        zip_ref.extractall(temp_folder)

# Step 2: Search for .csv files, rename them, and remove the first line (except for the first file)
csv_files = [file for file in os.listdir(temp_folder) if file.endswith(".csv")]
csv_files.sort()

for i, csv_file in enumerate(csv_files):
    new_name = str(i + 1) + ".csv"
    old_path = os.path.join(temp_folder, csv_file)
    new_path = os.path.join(temp_folder, new_name)

    os.rename(old_path, new_path)

    if i > 0:
        with open(new_path, 'r') as file:
            lines = file.readlines()

        with open(new_path, 'w', newline='') as file:
            writer = csv.writer(file)
            writer.writerows([line.strip().split(',') for line in lines[1:]])

# Step 3: Join all .csv files into a new file called 'report_final' in the root folder
report_path = os.path.join(root_folder, report_file)

with open(report_path, 'a', newline='') as report:  # Changed 'w' to 'a' for append mode
    writer = csv.writer(report)
    for csv_file in csv_files:
        csv_path = os.path.join(temp_folder, csv_file)
        with open(csv_path, 'r') as file:
            lines = file.readlines()
            writer.writerows([line.strip().split(',') for line in lines])

# Cleanup: Remove the 'temp' folder
shutil.rmtree(temp_folder)

print("Report created successfully.")
